const Net = require('net');
const { buffer } = require('stream/consumers');

const PORT  = 8888;

const server = Net.createServer();
const clients = new Set();

const packets = {
    1: 'ddccbbaa0100000000000000ea07011c15020e7c0100000000',
    2: 'ddccbbaa020000006f000000ea07011c15020cff00ac00000001000000000000010000000000000000000300000000180d8f0000000000f9029500000000a8610000000000000000000000000000000000000000000000000000000000000080af5754010000000081485d01000000a8610000000000000000000000000000000000000000000000000000000000000000d3fb2f0100000000b4f13501000000a8610000000000000000000000000000000000000000000000000000000000000001000000',
    4: 'ddccbbaa0400000000000000ea07011c15020e7c012e000000413238303132360031333037333900e59d366e2ef50ec057c8786e2380d449404e00000000000000000700809e42',
    6: 'ddccbbaa0600000000000000ea07011c150d05c802240100009200000000000000000000000100000040ab41910000000001000000444a49204d696e69342070726f28524944290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000003135383146365a3900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
    90: 'ddccbbaa9000000000000000eaff07011c15020c000400000000000000',
    92: 'ddccbbaa9200000000000000ea07011c150d05c802cc000000010000003135383146365a390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000444a49204d696e69342070726f28524944290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040ab41910000000000000000000000000080684004000000000000000100000076543541d4d14940e50e9bc8cc450fc0bde3141dc9d149407b319413ed4a0fc00000824200000000',
    101: 'ddccbbaa1010000000000000ea07011c15020e7c0100000000',
}

server.on('connection', function(sock){
    console.log("CONNECTED: " + sock.remoteAddress + ":" + sock.remotePort);
    clients.add(sock);
    
    sock.on('data', function(data){
        console.log("DATA " + sock.remoteAddress + ":" + data);
        
        const packet = Buffer.from(packets[1], 'hex');
        sock.write(packet);
    });

    sock.on('end', function(){
        console.log('CONNECTION CLOSED: ' + sock.remoteAddress + ':' + sock.remotePort);
        clients.delete(sock)
    });

    sock.on('error', function(err){
        console.log(`Error ${sock.remoteAddress}: ${err}`);
        clients.delete(sock);
    });
});

server.listen(PORT, () => {
    console.log('TCP server is running on port' + PORT);
});


process.stdin.setEncoding('utf8');
process.stdin.on('data', input =>{
    const cmd = input.trim();

    const hex = packets[cmd];
    if(!hex){
        console.log(`Unknown command: ${cmd}`);
        return;
    }

    const packet = Buffer.from(hex, 'hex');
    console.log(`Sending command ${cmd}`);

    for(const sock of clients){
        sock.write(packet);
    }
});
